apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: connect-proxy
  namespace: default
spec:
  interval: 30m
  chart:
    spec:
      chart: oauth2-proxy
      version: "3.4.x"
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  values:
    ingress:
      enabled: true
      hostname: authproxy.wisv.ch
      tls: true
    redis:
      enabled: false
    configuration:
      oidcIssuerUrl: https://connect.ch.tudelft.nl
      redirectUrl: https://authproxy.wisv.ch
    extraEnvVars:
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_PROVIDER_DISPLAY_NAME: "CH Connect"
      OAUTH2_PROXY_REDIRECT_URL: https://authproxy.wisv.ch/oauth2/callback
      OAUTH2_PROXY_ISSUER_URL: https://connect.ch.tudelft.nl
      OAUTH2_PROXY_OIDC_GROUPS_CLAIM: ldap_groups
      OAUTH2_PROXY_ALLOWED_GROUP: staff
  valuesFrom:
    - kind: Secret
      name: connect-proxy
      valuesKey: client-id
      targetPath: configuration.clientID
    - kind: Secret
      name: connect-proxy
      valuesKey: client-secret
      targetPath: configuration.clientSecret
    - kind: Secret
      name: connect-proxy
      valuesKey: client-cookie
      targetPath: configuration.cookieSecret